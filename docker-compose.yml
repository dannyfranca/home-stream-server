# =============================================================================
# Home Stream Server - Docker Compose Stack
# =============================================================================
# A complete home media streaming solution with VPN-protected downloads
#
# Services:
#   - Gluetun:     VPN client (NordVPN WireGuard)
#   - qBittorrent: Torrent client (behind VPN)
#   - Prowlarr:    Indexer management (behind VPN)
#   - Sonarr:      TV show automation
#   - Radarr:      Movie automation
#   - Bazarr:      Automatic subtitles
#   - Jellyfin:    Media streaming server
#   - Jellyseerr:  Request management UI
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose up -d (or podman compose up -d)
#
# Note: Config directories use named volumes for Podman rootless compatibility.
#       Media/torrents use bind mounts for easy access from the host.
# =============================================================================


services:
  # ===========================================================================
  # VPN Client - All torrent traffic routes through this container
  # ===========================================================================
  gluetun:
    image: docker.io/qmcgaw/gluetun:v3.40.3
    container_name: gluetun
    # Required for Podman rootless mode to access TUN device
    privileged: true
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=nordvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-Netherlands}
      # - SERVER_CITIES=${SERVER_CITIES}
      - TZ=${TZ}
      # Kill switch - block traffic if VPN drops
      - FIREWALL_VPN_INPUT_PORTS=
      - FIREWALL_INPUT_PORTS=${QBITTORRENT_PORT},${PROWLARR_PORT}
      # Allow outbound traffic to local networks (for flaresolverr, sonarr, radarr, etc.)
      # These are RFC 1918 private IP ranges - they cover all standard container and home networks:
      #   - 10.88.0.0/16: Podman default network
      #   - 172.16.0.0/12: Docker default + compose networks
      #   - 192.168.0.0/16: Most home LANs
      # Override via LOCAL_NETWORK_SUBNETS in .env if your setup differs
      - FIREWALL_OUTBOUND_SUBNETS=${LOCAL_NETWORK_SUBNETS:-10.88.0.0/16,172.16.0.0/12,192.168.0.0/16}
    ports:
      # qBittorrent WebUI (exposed through gluetun)
      - "${QBITTORRENT_PORT:-8090}:${QBITTORRENT_PORT:-8090}"
      # Prowlarr WebUI (exposed through gluetun)
      - "${PROWLARR_PORT:-9696}:${PROWLARR_PORT:-9696}"
    volumes:
      - gluetun_config:/gluetun
    # Allow containers using gluetun's network to resolve other container names
    # This is required for Podman where VPN DNS can't resolve container hostnames
    extra_hosts:
      - "flaresolverr:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://ipinfo.io"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================================================
  # Torrent Client - Routes through VPN via gluetun network
  # ===========================================================================
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:5.1.4-r1-ls431
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=${QBITTORRENT_PORT:-8090}
    volumes:
      - qbittorrent_config:/config
      - ${DATA_PATH}/torrents:/data/torrents
    restart: unless-stopped

  # ===========================================================================
  # Indexer Manager - Routes through VPN for privacy
  # ===========================================================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:2.3.0.5236-ls133
    container_name: prowlarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - prowlarr_config:/config
    restart: unless-stopped

  # ===========================================================================
  # Cloudflare Bypass - Required for some indexers (1337x, TorrentGalaxy, etc.)
  # ===========================================================================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:v3.4.6
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - LOG_HTML=false
      - TZ=${TZ}
    ports:
      - "8191:8191"
    restart: unless-stopped

  # ===========================================================================
  # TV Show Automation
  # ===========================================================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:4.0.16.2944-ls299
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - sonarr_config:/config
      - ${DATA_PATH}:/data
    ports:
      - "${SONARR_PORT:-8989}:8989"
    restart: unless-stopped

  # ===========================================================================
  # Movie Automation
  # ===========================================================================
  radarr:
    image: lscr.io/linuxserver/radarr:6.0.4.10291-ls288
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - radarr_config:/config
      - ${DATA_PATH}:/data
    ports:
      - "${RADARR_PORT:-7878}:7878"
    restart: unless-stopped

  # ===========================================================================
  # Automatic Subtitle Downloads
  # ===========================================================================
  bazarr:
    image: lscr.io/linuxserver/bazarr:v1.5.3-ls326
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - bazarr_config:/config
      - ${DATA_PATH}/media:/data/media
    ports:
      - "${BAZARR_PORT:-6767}:6767"
    restart: unless-stopped

  # ===========================================================================
  # Media Streaming Server
  # ===========================================================================
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:10.11.4ubu2404-ls10
    container_name: jellyfin
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      # Optional: JELLYFIN_PublishedServerUrl for reverse proxy
    volumes:
      - jellyfin_config:/config
      - ${DATA_PATH}/media:/data/media
      # Optional: Use RAM for transcoding (faster)
      # - /dev/shm:/transcode
    ports:
      - "${JELLYFIN_PORT:-8096}:8096"
      # HTTPS (optional)
      # - 8920:8920
      # Service discovery (optional)
      # - 7359:7359/udp
      # - 1900:1900/udp
      # Uncomment for hardware transcoding:
      # Intel QuickSync:
      # devices:
      #   - /dev/dri:/dev/dri
      # NVIDIA (requires nvidia-container-toolkit):
      # runtime: nvidia
      # deploy:
      #   resources:
      #     reservations:
      #       devices:
      #         - capabilities: [gpu]
    restart: unless-stopped

  # ===========================================================================
  # Plex Media Server (Alternative to Jellyfin)
  # ===========================================================================
  plex:
    image: lscr.io/linuxserver/plex:1.42.2.10156-f737b826c-ls286
    container_name: plex
    network_mode: host
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      # Optional: Claim your server at https://plex.tv/claim
      # - PLEX_CLAIM=${PLEX_CLAIM}
    volumes:
      - plex_config:/config
      - ${DATA_PATH}/media:/data/media
      # Optional: Use RAM for transcoding (faster)
      # - /dev/shm:/transcode
      # Uncomment for hardware transcoding:
      # Intel QuickSync:
      # devices:
      #   - /dev/dri:/dev/dri
    restart: unless-stopped

  # ===========================================================================
  # Media Request Management UI
  # ===========================================================================
  jellyseerr:
    image: docker.io/fallenbagel/jellyseerr:2.7.3
    container_name: jellyseerr
    environment:
      - TZ=${TZ}
      - LOG_LEVEL=info
    volumes:
      - jellyseerr_config:/app/config
    ports:
      - "${JELLYSEERR_PORT:-5055}:5055"
    restart: unless-stopped
    depends_on:
      - jellyfin

# =============================================================================
# Named Volumes - Managed by Docker/Podman for automatic permissions
# =============================================================================
volumes:
  gluetun_config:
  qbittorrent_config:
  prowlarr_config:
  sonarr_config:
  radarr_config:
  bazarr_config:
  jellyfin_config:
  plex_config:
  jellyseerr_config:
